---
title: 卡顿入门
icon: hugeicons:chat-delay
createTime: 2026/02/05 12:54:41
permalink: /docs/basic/lag/
foo: foo
tags:
    - 操作
    - 信息
---
如果你是一位开了一段时间服务器的服主或~~老练的⭕️💰🏃‍♀️~~，那么你就可能经常听到玩家抱怨“好卡啊”、“掉帧”、“延迟高”等问题。嗯……确实是个头疼的问题呢，那么本指南将帮助你系统性地理解什么是卡顿、为什么会卡顿。以及如何解决卡顿问题。

## 1. 认识卡顿

### 1.1 什么是卡顿？

在Minecraft服务器中，“卡顿”是一个笼统的说法，实际上包含了三种完全不同的问题：

:::: card-grid
::: card title="服务器卡顿（Server Lag / TPS下降）" icon="mdi:server-network-off"
所有玩家同时感到游戏“慢动作”，方块延迟破坏，生物移动卡顿
- **原因**：服务器运算能力不足，无法按时完成每个游戏刻（tick）的计算
- **影响范围**：所有在线玩家
:::
::: card title="客户端卡顿（Client Lag / FPS下降）" icon="tabler:devices-pc-off"
画面不流畅，操作有延迟感，但其他玩家正常
- **原因**：玩家电脑性能不足，显卡、CPU无法流畅渲染游戏画面
- **影响范围**：单个玩家
:::
::: card title="网络延迟（Network Lag / Ping高）" icon="hugeicons:cellular-network-offline"
操作后延迟反馈，打字聊天延迟，但画面流畅
- **原因**：玩家到服务器的网络连接质量差
- **影响范围**：个别玩家或特定地区玩家
:::
::::

### 1.2 TPS是什么？

**TPS（Ticks Per Second）**是衡量服务器性能最重要的指标。

- Minecraft服务器的目标是每秒运行**20个游戏刻（tick）**
- 每个tick服务器需要完成：
  - 处理所有实体（玩家、生物、掉落物）的移动
  - 更新方块状态（红石、农作物生长、熔炉冶炼）
  - 处理区块加载和卸载
  - 执行插件/模组的逻辑
  
| 评价 | TPS数值范围 |
| --- | ------------ |
| 正常 | 20.0（满分） |
| 轻微卡顿 | 18-19 |
| 明显卡顿 | 15-17 |
| 严重卡顿 | 低于15 |

**还不明白？**假设一个服务器TPS降到10，那么这也就意味着游戏运行速度只有正常的50%，所有玩家都会感到游戏在“慢放”。

### 1.3 MSPT是什么？

**MSPT（Milliseconds Per Tick）**表示服务器处理一个tick需要多少毫秒。

- 理想值：**低于50ms**
- 计算公式：1秒 = 1000毫秒，1000ms ÷ 20 ticks = 50ms/tick
- 如果MSPT超过50ms，TPS就会下降
- 例如：MSPT = 100ms 时，服务器就只能达到 10 TPS

## 2. 卡顿的根源

### 2.1 硬件的问题？

硬件导致卡顿的现象教程出现在各大服主当中，就算是经验再丰富的服主也难免不了碰到这种事。

如果要从硬件层面入手，那么你首要关注的层面就是**CPU**，你需要知道的是：Minecraft服务器是**CPU密集型**应用，==对单核性能要求很高==。

**常见误区**：
- ❌“我的CPU有8核，肯定够用” → Minecraft主要使用1-2个核心
- ✅“我的CPU单核主频高” → 这才是关键！

**推荐配置**：
- **小型服务器**（1-10人）：主频3.0GHz以上的CPU
- **中型服务器**（10-50人）：主频3.5GHz以上，至少4核
- **大型服务器**（50人以上）：主频4.0GHz以上，6核或更多

除此之外，**内存（Memory）**不足会导致频繁的垃圾回收（GC），造成卡顿。

这里有一份**内存分配指南**：
- **纯净服**（无插件）：1-2GB
- **小型插件服**（10个插件以内）：2-4GB
- **中型插件服**（20-50个插件）：4-8GB
- **大型模组服**（100+模组）：8-16GB甚至更多

::: warning
分配过多内存反而可能导致GC卡顿！
:::

同时，**磁盘（Disk）**的读写速度影响区块加载和世界保存。

- **机械硬盘（HDD）**：读写速度100-200MB/s，会造成区块加载延迟
- **固态硬盘（SSD）**：读写速度500-3500MB/s，强烈推荐
- **NVMe SSD**：读写速度3000-7000MB/s，最佳选择

::: card title="小小总结一下" icon="fluent-emoji-high-contrast:memo"
你需要关注的硬件一般就只有这三个：
1. **CPU**：主要看单核性能，单核性能好才是真的好
2. **内存**：内存能扩大就尽量扩大，但是别扩太大
3. **硬盘**：当然是越大越好，越大，能储存的东西就越多
:::

### 2.2 游戏里的问题？

如果问题出现在游戏内容这一方面的话，问题会简单许多。

首先，**实体（Entity）**是影响服务器性能的一个主要原因。每个实体都需要服务器每tick计算其AI、移动、碰撞等。

**性能杀手 - 排行榜**：
::: steps
1. **掉落物（Drops）**

    掉落物属于一种物品实体，成百上千的掉落物会严重拖累性能

2. **生物（Mob）**

    大多数生物都有特定的AI系统，过多的生物也会造成导致服务器卡顿，尤其是村民（复杂AI）、僵尸（寻路算法）等一类的生物

3. **矿车、船**

    加载这些交通工具等同于加载实体，加载实体也需要消耗一部分服务器的资源，实体过多则会导致加载量变大，进一步导致服务器卡顿

4. **盔甲架**

    盔甲架也属于实体，数量过多时性能影响会变得显著一些

:::

可以根据这份**判断标准**来辅助分析：
- 正常：总实体数 < 500
- 警告：总实体数 > 1000
- 危险：总实体数 > 3000

如果不是，那么第二个可能的原因就是：**区块（Chunk）**

:::: card-grid
::: card title="是不是区块加载过多？"
- 每个玩家周围会加载一定半径的区块
- 服务器配置文件中的`view-distance`（视距）越大，加载的区块越多
- 建议值：4-8（默认10可能过高）
:::
::: card title="是不是刷怪塔/红石机械？"
- 高频红石电路每tick都要计算
- 大型刷怪塔产生大量生物
- 漏斗链和漏斗矿车消耗大量性能
:::
::::

还不是？那只能是你**世界（World）**存档问题了。
- 世界文件越大，自动保存时间也就越长
- 保存时可能造成明显卡顿
- 建议你定期清理未使用的区域

### 2.3 插件和模组的问题？

如果你把问题范围缩小到插件和模组层面上，那么查找源头就不是一件难事。

#### 1. **插件质量问题**

新手服主经常踩的一个坑就是乱安装插件，但**某些插件因为代码不佳**，会严重拖累服务器，这些插件一般是：
- 没有异步处理的数据库操作
- 过于频繁的循环检测（每tick都执行）
- 内存泄漏（使用后不释放内存）

所以不要使用质量堪忧的插件，尤其是那些优化差的，用了就服务器就爆炸💥的那种。

#### 2. **插件冲突**

还有的服主，不仅乱安装插件，还不清楚各个插件的功能和特性，这就会导致：

- 多个插件修改同一个游戏机制
- 事件监听器过多
- 插件之间互相调用导致死循环

所以安装插件前记得先弄清楚这个插件是什么再去安装吧……

#### 3. 模组性能问题

如果服务器的类型是**模组服务器**（Forge/Fabric），那么它相比插件服则更容易卡顿，因为：
- 模组修改游戏底层，性能开销更大
- 某些模组（如大型科技模组）计算量巨大
- 模组兼容性问题更难排查

## 3. 诊断卡顿

### 3.1 基础诊断命令

::: steps

1. **查看TPS**的命令是：

    ```plain title="命令"
    /tps
    ```
    或者使用插件，诸如Spark、EssentialsX等一类的插件来显示TPS。

    **输出示例**：
    ```
    TPS from last 1m, 5m, 15m: 20.0, 19.8, 19.5
    ```

2. **查看内存使用**的命令是：

    ```plain title="命令"
    /mem
    或
    /memory
    ```

    **你需要关注的两个指标**：
    - 已用内存 and 最大内存
    - GC（垃圾回收）频率

3. **查看实体数量**的命令是：

    ```plain title="命令"
    /forge entity list  (Forge服务器)
    /minecraft:execute in minecraft:overworld run data get entity @e  (原版)
    ```

    或者使用ClearLag等插件，输入命令：
    ```plain title="命令"
    /lagg check
    ```

:::

### 3.2 性能分析工具

#### 1. **Spark** <Badge type="tip" text="推荐" />

**Spark（火花）**是用于 Minecraft 客户端、服务端、代理端的性能分析插件/模组，可以说是==最专业的性能分析插件==，在Minecraft服主圈中被广泛使用和提及。

**安装方法**：
1. 下载Spark插件（支持Bukkit/Spigot/Paper/Forge/Fabric）
2. 放入`plugins`（插件版本）或`mods`（模组版本）文件夹
3. 重启服务器

**使用方法**：
```
/spark profiler start          # 开始分析
等待30-60秒(在卡顿时进行)
/spark profiler stop           # 停止分析
/spark profiler info           # 查看报告链接
```

**解读报告**：
- 打开网页报告，查看"Hot Spots"（性能热点）
- 然后找到占用CPU时间最多的插件/方法
- 如果你看到了**红色**或**深色**的项目，那么它应该就是你服务器的**性能瓶颈**

#### 2. **Timings报告（Paper服务器）**<Badge type="warning" text="弃用" />

Paper服务器曾经自带一个Timings v2性能分析器，但这个工具已经很久无人维护，其生成的报告对小白服主而言难以理解，自1.21版本起，该工具就已经被弃用并默认禁用，取而代之的便是大名鼎鼎的Spark。

如果你仍然坚持使用Timings，那么你可以使用这个命令开启记录：
```
/timings on      # 开启记录
等待5-10分钟
/timings paste   # 生成报告链接
```

点击生成的报告链接，然后重点查看这些指标：
- 看👉哪些插件占用时间最多
- 看👉哪些世界/区块问题最严重
- 看👉实体类型统计

#### 3. **ClearLagg插件**

**ClearLagg** 是一款专为 Minecraft Spigot/CraftBukkit 服务器设计的高性能优化插件，核心目标是减少延迟、降低服务器资源占用，并为服主提供灵活的性能管理工具。

ClearLagg插件的常用命令：
```
/lagg clear # 清理已配置的实体
/lagg killmobs # 清除指定类型生物
/lagg area <半径> # 清理指定范围实体
/lagg check # 查看世界信息与实体统计
/lagg tps # 查看TPS
/lagg unloadchunks # 卸载区块（不推荐新版本使用）
/lagg profile <时间> <类型> # 性能分析
/lagg memory # 实时查看内存使用
```

你可以使用这些命令来排查性能问题。

### 3.3 判断卡顿类型的方法

假设有一个玩家反馈“**卡**”了，那么该如何判断是哪种卡顿呢？你可以通过下面👇这张表来加以辅助判断：

| 症状 | 服务器卡顿 | 客户端卡顿 | 网络延迟 |
|------|----------|----------|---------|
| TPS低于20 | ✅ | ❌ | ❌ |
| 所有玩家同时卡 | ✅ | ❌ | ❌ |
| 只有个别玩家卡 | ❌ | ✅ | ✅ |
| 画面不流畅 | ❌ | ✅ | ❌ |
| 操作延迟但画面流畅 | ❌ | ❌ | ✅ |
| F3调试界面FPS低 | ❌ | ✅ | ❌ |

## 4. 解决服务器卡顿

### 4.1 优化服务器配置

#### 1. `server.properties` 优化

打开`server.properties`文件，修改以下参数：

```properties title="server.properties"
# 视距(越小性能越好，但玩家可见范围小)
view-distance=6
simulation-distance=4

# 网络优化
network-compression-threshold=256

# 最大玩家数(根据硬件调整)
max-players=50
```

**参数说明**：
- `view-distance`：即玩家周围加载的区块半径，默认值为`10`，建议4-8
- `simulation-distance`：即实际运行逻辑的区块半径，1.18+版本才有
- `network-compression-threshold`：即网络压缩阈值，降低可减少CPU占用

#### 2. `bukkit.yml` 优化 <Badge type="info" text="Spigot / Paper" />
```yaml
settings:
  # 自动保存间隔(单位:tick，20tick=1秒)
  autosave: 6000  # 从默认6000改为更大值减少卡顿

chunk-gc:
  # 区块垃圾回收周期
  period-in-ticks: 600

ticks-per:
  # 各种生物生成间隔(增大可减少性能消耗)
  monster-spawns: 1
  animal-spawns: 400
  water-spawns: 1
  water-ambient-spawns: 1
  ambient-spawns: 1
```

#### 3. `spigot.yml` 优化 <Badge type="info" text="Spigot / Paper" />
```yaml
world-settings:
  default:
    # 实体激活范围(减小可提升性能)
    entity-activation-range:
      animals: 16  # 默认32
      monsters: 24  # 默认32
      raiders: 48
      misc: 8  # 默认16
      
    # 实体追踪范围
    entity-tracking-range:
      players: 48
      animals: 48
      monsters: 48
      misc: 32
      
    # 生长速度(100=正常，50=两倍慢)
    growth:
      cactus-modifier: 100
      cane-modifier: 100
      melon-modifier: 100
      mushroom-modifier: 100
      pumpkin-modifier: 100
      sapling-modifier: 100
      beetroot-modifier: 100
      carrot-modifier: 100
      potato-modifier: 100
      wheat-modifier: 100
      
    # 每tick合并的经验球范围
    merge-radius:
      exp: 3.0
      item: 2.5
      
    # 每个玩家可保存的区块数量
    max-entity-collisions: 8
```

#### 4. `paper.yml` 优化 <Badge type="info" text=" Paper" />
Paper服务器端有额外优化选项：

```yaml
world-settings:
  default:
    # 限制每chunk的生物数量
    spawn-limits:
      monster: 70
      creature: 10
      ambient: 15
      water-creature: 5
      water-ambient: 20
      
    # 优化爆炸计算
    optimize-explosions: true
    
    # 限制容器检测范围(漏斗等)
    hopper:
      disable-move-event: false
      
    # 反X-Ray(可能消耗性能)
    anti-xray:
      enabled: false
      
    # 每tick最多处理的区块数
    max-auto-save-chunks-per-tick: 24
    
    # 禁用某些性能消耗大的特性
    armor-stands-tick: false  # 盔甲架不tick
    per-player-mob-spawns: true  # 每个玩家独立计算刷怪
```

### 4.2 启动参数优化

> 详情见：[启动脚本入门](/guide/ji-chu-zhi-shi-xue-xi/startup/)

以下是一段基础启动脚本的参数：

```bash
java -Xms4G -Xmx4G -jar server.jar nogui
```

**参数说明**：
- `-Xms4G`：初始内存4GB
- `-Xmx4G`：最大内存4GB
- 建议 `Xms` 和 `Xmx` 设置为相同值
- `nogui`：不启动图形界面（节省资源）

**Aikar's Flags** <Badge type="tip" text="推荐" />

Aikar's Flags参数是一套广为流传的优化启动脚本参数，也是一套经过优化的JVM参数，它适用于大多数服务器:

```bash
java -Xms8G -Xmx8G -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 -Dusing.aikars.flags=https://mcflags.emc.gs -Daikars.new.flags=true -jar server.jar nogui
```

**简化版（4-8GB内存）**:
```bash
java -Xms4G -Xmx4G -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:InitiatingHeapOccupancyPercent=15 -XX:MaxTenuringThreshold=1 -jar server.jar nogui
```

**超大内存版（12GB以上）**:
```bash
java -Xms12G -Xmx12G -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=40 -XX:G1MaxNewSizePercent=50 -XX:G1HeapRegionSize=16M -XX:G1ReservePercent=15 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=20 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 -jar server.jar nogui
```

### 4.3 清理和限制实体

#### 1. 安装LagFixer插件

要想清理和实体一方面的垃圾，你需要安装一些==优化插件==，其中比较知名的一个优化插件就是LagFixer。

它的功能：
- 定时清理掉落物
- 限制实体数量
- 清理卡顿区块

**配置示例**（config.yml）：
```yaml
auto-removal:
  enabled: true
  # 每15分钟清理一次
  interval: 900
  
  # 清理目标
  remove:
    items: true
    arrows: true
    boats: false
    falling-blocks: true
    
  # 警告时间(秒)
  warnings:
    - 300  # 5分钟前警告
    - 180
    - 60
    - 30

# 每个区块的实体限制
limit:
  enabled: true
  max: 100
  check-interval: 60
```

#### 2. 手动清理命令

你也可以直接用Minecraft原版的命令清理垃圾，简单粗暴，但是**不推荐**，因为它可能会清理掉一些有用or重要的东西……

```
/kill @e[type=item]              # 清理所有掉落物
/kill @e[type=arrow]             # 清理箭矢
/kill @e[type=item_frame]        # 清理物品展示框
/kill @e[type=!player]           # 清理除玩家外所有实体(危险!)
```

::: warning 警告
不要随意使用这些命令！
:::

#### 3. 区块限制插件

安装这一类插件或许是一个不错的选择？要不在下面这些插件中挑一个吧（可恶，怎么都停更了!!别看我，我也不知道!!）：
- **PerWorldPlugins** <Badge type="warning" text="停更" />
- **EntityPlus** <Badge type="warning" text="停更" />
- **MobLimiter** <Badge type="warning" text="停更" />

安装完成后，可查看相关的插件文档帮助以进行相关的优化操作。这里不做详细讲解。

### 4.4 优化红石和农场

可以安装一些红石优化相关的插件来缓解问题，这里列举几个：
- BetterRedstone
- AntiRedstoneLag
- RedstoneOptimizer
- AntiRedstone

当然，也可以通过禁止特定的红石机械来阻止那些红石机械对服务器的卡顿行为，你可以在某些插件中找到禁止特定红石机械的配置选项：
```yaml
# 禁止高频红石
ban-redstone-clock: true
max-redstone-frequency: 2  # 每秒最多2次

# 限制漏斗
hopper:
  transfer-cooldown: 8  # 默认8tick，增大可减轻负担
```

#### 3. 制定规则
如果那些玩家，哦不，那些~~刁民~~们，实在是不听话的话，那么你可以制定一些服务器规则来限制这些~~刁民~~的行动，例如你可以规定：
- 禁止建造超大型自动农场
- 红石机械必须有开关
- 不用时关闭机械
- 限制刷怪塔规模

### 4.5 世界管理

#### 1. 预生成区块

可以用预生成世界区块的方法来缓解==跑图所带来的卡顿问题==，使用**Chunky**插件预生成地图边界，输入如下命令：

```
/chunky world world          # 选择世界
/chunky radius 5000          # 设置半径(方块)
/chunky start                # 开始生成
```

**这样做的好处就是**：
- 避免玩家跑图时实时生成区块导致卡顿
- 减少世界文件碎片

#### 2. 设置世界边界

不过，要是那些~~刁民~~跑图跑的太猛了，也可以设置**世界边界（World border）**大小来阻止跑图，不过一般情况是大可不必的……

::: warning
除非有特殊需求，否则一般情况下根本不需要动世界边界的大小，如果要限制跑图，那么这个设置项的作用就是微乎其微，也可以说是毫无作用。
:::

```
/worldborder set 10000       # 设置边界为10000方块
/worldborder center 0 0      # 设置中心点
```

#### 3. 定期清理区块
你可以使用**WorldBorder**或**Trim**一类的插件以删除长期无人访问（不使用）的区块，==不仅能减小世界文件大小，还能加快自动保存速度==。

::: warning
操作前务必进行一次备份，以防万一！
:::

### 4.6 插件优化

精简插件就是减少服务器上不必要的插件，可以在一定程度上减少占用并优化性能。

注意，你的核心原则就是：==**只装必要的插件**=={.important}

检查方法：
1. 列出所有插件
2. 思考：这个插件真的必要吗？
3. 能否用配置文件实现同样功能？
4. 能否合并功能相似的插件？

而且，许多插件有大量默认功能，**你可以关掉不用的功能**。

需要一个例子？比如在EssentialsX插件的`config.yml`配置文件中：
```yaml title="config.yml"
# 禁用不需要的命令
disabled-commands:
  - nick
  - fly
  - god
  
# 禁用不必要的监听器
remove-god-on-disconnect: false
repair-enchanted-items: false
```

**换装更好的插件**可以在一定程度上解决性能问题，下面也给出了一些例子：

| 功能 | 原插件 | 更好的替代品 |
|------|-----------|-----------|
| 权限管理 | PermissionsEx | LuckPerms / GroupManager |
| 经济系统 | iConomy | Vault + EssentialsX |
| 领地保护 | WorldGuard旧版 | WorldGuard 7+ |
| 基础功能 | Essentials旧版 | EssentialsX / CMI / SunLight |

### 4.7 数据库优化

对于==大型服务器==而言，我们更推荐使用使用MySQL而非SQLite，为什么？因为：
- SQLite的性能有限
- 而MySQL可以分离到另一台机器
- MySQL还支持连接池，并发性能比较好

我们也非常建议**启用异步数据库操作**，确保插件配置中启用了以下配置选项：
```yaml
database:
  type: mysql
  async: true  # 异步操作，不阻塞主线程
  connection-pool: true
```

### 4.8 选择合适的服务端

以下是一些常见服务端的性能排行榜（从低到高）：

::: steps
1. **Vanilla（原版服务端）**：无优化
2. **CraftBukkit**：基础优化
3. **Spigot**：较多优化
4. **Paper**：大量优化
5. **Purpur**：Paper基础上更多自定义
6. **Airplane/Pufferfish**：极致性能优化
:::

不过对于第一次开服的小白服主来说，**一个更好的选择是Paper服务端**。

怎么说呢，Paper它：
- 兼容性好（兼容Spigot插件，部分插件甚至是Paper专用）
- 性能提升明显（比Vanilla服务端快了30-50%）
- 文档完善（Paper附带一个帮助文档，一直在更新）
- 更新及时（Paper服务端总是会第一时间更新版本）

## 5. 解决客户端卡顿

显然**这并不是服务器问题**，但作为服主的你，帮助~~刁民~~解决客户端问题也很重要啦 (∠・ω< )⌒★

### 5.1 优化客户端设置

#### 1. 降低视频设置

首先让一些还在用低配电脑的~~刁民~~调整以下视频设置选项：

- **渲染距离**：降至8-12区块
- **最大帧率**：限制到60-120 FPS（除非Ta有高刷新率显示器）
- **平滑光照**：关闭或最小
- **粒子效果**：降低
- **实体距离**：降低

#### 2. 分配更多内存给客户端

可以在启动器中设置内存分配数值，以下是一些参考范围：
- 2-4GB适合纯净客户端
- 4-8GB适合轻量模组包
- 8-16GB适合大型模组包

### 5.2 安装优化模组

#### Fabric：

安装优化类模组已经成为主流，甚至还有专门的优化整合包出现在社区里，这些整合包一般安装了较多的优化模组，设置选项都经过作者的精心调整。

这里列出了一些Fabric优化模组：
- **Sodium（钠）**：渲染优化模组（FPS提升50-200%）
- **Lithium（锂）**：游戏逻辑优化模组
- **Phosphor（磷）** <Badge type="warning" text="停更" />：光照优化模组
- **Iris**：光影支持模组
- **FerriteCore（FC，铁氧体磁芯）**：内存优化模组
- ……

#### Forge：

对于Forge而言，并没有太多的优化调整空间，因为Forge本身就很笨重，加载速度也慢。

不过这并不代表，以下列出了一些Forge优化模组：
- **OptiFine**：经典优化模组，但兼容性和稳定性非常差!!一定是OptiFine干的！!!
- **FoamFix** <Badge type="warning" text="停更" />：内存优化模组
- **BetterFPS** <Badge type="warning" text="停更" />：帧率优化模组
- **Embeddium** <Badge type="warning" text="停更" />：Sodium分支，渲染优化模组
- **Rubidium（铷）** <Badge type="warning" text="停更" />：Sodium的非官方Forge版。
- **Chloride**：钠/Embeddium附属 的一个分支。
- ……

### 5.3 更新显卡驱动

这个不必多说，显卡驱动应该都是会更新的：
- NVIDIA用户：直接访问官网下载最新驱动，也可以使用NVIDIA APP
- AMD用户：同样更新最新驱动
- 集成显卡：确保芯片组驱动最新

## 6. 解决网络延迟

*网络延迟？那就好办了，这应该对所有服主来说都是个不陌生的东西。*

### 6.1 服务器端优化

在服务器层面解决网络问题的话……不算太难，也不算太简单，只需要一点脑子就行。

**选择位置**：

首先你要考虑**你的服务器位置**，它可能==在一定程度上影响你服务器玩家的网络延迟==。一般情况下，你只需要考虑：**玩家主要地处哪个地区？哪个地区的玩家分布比较多？**，随后**选择距离玩家最多的地方最近的机房位置**

如果是国内玩家，就选择国内服务器（~~废话~~）；如果是~~跨国玩家~~……你还有外国玩家？emmm……可能还有外国留学生吧。那就选择中间位置或多线BGP，这样会好很多。

**CDN加速**：

给服务器上CDN加速也是个很好的办法，CDN加速可以**显著降低玩家延迟、提升资源加载速度并增强服务器稳定性**，通过将游戏内容分发至全球边缘节点，确保玩家从最近服务器获取数据，从而优化服务器的游戏体验并有效抵御网络攻击。

::: warning
Minecraft本身不使用HTTP协议，CDN对游戏连接无效，但可用于:
- 服务器网站
- 皮肤站
- 资源包下载
:::

哦对了，在 `server.properties` 配置文件中还有这么一条参数：
```properties
network-compression-threshold=256
```
对这条参数的简单解释就是：数值越小，压缩越多，但CPU消耗越大。

::: info Bungeecord压缩
如果你使用的是群组服（以Bungeecord为例）的话，就：
```yaml
# bungeecord config.yml
network_compression_threshold: 256
```
:::

### 6.2 玩家端解决方案

这应该不需要教都会的，作为萌新服主的你，如果确定是玩家端的问题，那么你只需要引导玩家，哦不，引导~~刁民~~：

| 玩家措施 | 详细描述 |
| ------- | -------- |
| 检查网络环境 | 关闭其他占用带宽的程序（下载、视频），并尽量使用有线连接代替WiFi，再看看是否有人占用网络，再不行就重启路由器
| 使用加速器 | 可以用UU加速器、奇游加速器、Biubiu加速器等等加速器来优化路由 |
| 更换更快的DNS | 114.114.114.114（国内）；8.8.8.8（Google）；1.1.1.1（Cloudflare） |

### 6.3 诊断网络问题

让你服务器的遇到网络问题的~~刁民~~在命令行执行：
```
ping 你的服务器IP
```

然后再参考下面这张表来判断网络延迟是否良好：

| Ping值 | 评价 |
| ------ | ---- |
| < 50ms | 优秀 |
| 50-100ms | 良好 |
| 100-200ms | 一般 |
| > 200ms | 较差 |

::: tip
如果丢包率大于5%，也可以判定为网络不稳定 
:::

再不济还可以试试路由追踪（Traceroute）：
```
tracert 你的服务器IP    (Windows)
traceroute 你的服务器IP  (Linux/Mac)
```
然后就可以看到数据包经过的每一跳，找出延迟高的节点。

## 7. 预防性维护

你可以做一些简单的工作来预防卡顿。

### 7.1 定期备份

使用自动备份插件来定期备份你的服务器，~~我知道你不想找插件~~，所以我给你找好了*（你看我对你多好）*：
- DriveBackupV2
- SimpleBackup <Badge type="warning" text="停更" />
- Prime Backup
- Advanced Backups <Badge type="warning" text="停更" />

配置示例：
```yaml
backup:
  # 每6小时备份一次
  interval: 21600
  
  # 保留最近10个备份
  keep: 10
  
  # 备份内容
  backup-worlds: true
  backup-plugins: true
```

- **频率**：每天至少1次
- **存储**：备份到不同硬盘/服务器
- **测试**：定期测试备份能否恢复
- **版本**：保留多个历史版本

### 7.2 使用性能监控插件

依旧是先来一波插件列举：
- LagMonitor <Badge type="warning" text="停更" />
- Spark
- Plan

如果有条件，就可以设置个自动告警原则，当满足以下条件时提醒服务器OP：
- TPS < 18持续1分钟
- 内存使用 > 90%
- 玩家突然掉线
- 服务器崩溃

这些东西需要你编写一个机器人程序来实现，~~当然我知道你没这技术~~。

### 7.3 定期清理

如果你不确定或清楚该怎么做，可以参考这份**清理任务checklist**：

::: card title="每天"
- [ ] 清理掉落物
- [ ] 重启服务器（可选，某些情况下有助于释放内存）
:::
::: card title="每周"
- [ ] 清理玩家数据（长期未登录）
- [ ] 清理日志文件
:::
::: card title="每月"
- [ ] 备份并清理旧世界
- [ ] 更新插件和服务端
- [ ] 检查硬盘空间
:::

你也可以设置一个**自动重启**的功能来==释放内存==，一般会使用脚本或插件来配置每天定时重启。

假设我们有一个自动重启的插件，然后再假设下面是这个插件的配置，那么你就像这样配置：

```yaml title="config.yml"
# 插件配置
restart:
  time: "04:00"  # 配置凌晨4点重启
  broadcast:  # 配置重启前的提醒信息内容
    - "服务器将在5分钟后重启进行维护"
    - "请保存好物品并下线"
  warnings: # 配置还剩多久的时候提醒一次，以秒为单位，可以设置多次
    - 300  # 5分钟前
    - 180
    - 60
    - 30
```

### 7.4 更新策略

:::: card-grid
::: card title="Minecraft版本更新"
- **不要盲目更新**！先等待插件适配
- **先在测试服测试**，确保稳定再更新主服
- **更新前先提前告知玩家**，通知更新时间和内容
:::
::: card title="插件更新"
- 关注插件更新日志
- 优先更新修复重大bug的版本
- 新功能更新可以等待观望
:::
::::

## 8. 进一步讨论 <Badge type="tip" text="拓展" />

### 8.1 分布式服务器架构

或许你应该试试BungeeCord/Velocity群组服，它们可以将服务器拆分成多个子服，举个例子，这是一个群组服的子服结构：
- **Hub服**（大厅）：玩家进入点，轻量级
- **生存服**：主要玩法
- **小游戏服**：独立的小游戏
- **创造服**：建筑玩家专用

**群组服的优势**：
- 分散压力！！
- 某个服崩溃不影响其他服
- 可针对不同服优化

对于超大型服务器（~~别想了，真要是超大型的话你就不会出现在这里了~~）而言，你还需要让服务器**负载均衡**，也对应核心问题：**避免卡顿现象的出现**。

什么意思呢？就是：
- 多个服务器运行相同内容
- 玩家自动分配到人少的服
- 还需要共享数据库

### 8.2 区块优化高级技巧

Paper等服务端支持**异步加载区块**，减少主线程阻塞：
```yaml title="paper.yml"
async-chunks:
  enabled: true
  threads: 4  # 使用4个线程加载区块
```

另外，`spigot.yml` 配置文件中还支持**延迟区块卸载**：
```yaml "spigot.yml"
chunk-unload-delay: 30  # 区块30秒后才卸载，减少反复加载
```

### 8.3 极限优化配置

仅适用于超大型服务器或极度卡顿情况：

```yaml title="paper.yml"
# 极限优化配置
world-settings:
  default:
    # 大幅降低实体范围
    entity-activation-range:
      animals: 8
      monsters: 16
      raiders: 24
      misc: 4
      
    # 禁用各种功能
    armor-stands-tick: false
    disable-chest-cat-detection: true
    container-update-tick-rate: 3
    
    # 降低生成数量
    spawn-limits:
      monster: 50
      creature: 5
      ambient: 1
      water-creature: 3
      water-ambient: 5
```

::: warning
这些配置会影响游戏体验，慎用！
:::

### 8.4 系统层面优化

::: steps

1. 使用Linux

    如果使用Linux服务器:

    ```bash
    # 增加文件描述符限制
    ulimit -n 65536

    # 优化网络参数
    echo "net.core.rmem_max = 16777216" >> /etc/sysctl.conf
    echo "net.core.wmem_max = 16777216" >> /etc/sysctl.conf
    sysctl -p
    ```

2. 使用Ramdisk

    将服务器临时文件放在内存盘:
    ```bash
    # 创建4GB内存盘
    mkdir /mnt/ramdisk
    mount -t tmpfs -o size=4096M tmpfs /mnt/ramdisk

    # 将临时世界文件放这里
    ```

    ::: warning
    服务器关闭后数据丢失，需要定期同步到硬盘！
    :::

:::

## 9. 常见问题解答（FAQ）

### Q1：为什么重启后服务器快，一段时间后又卡了？
**A**：可能原因：
1. **内存泄漏**：某个插件/模组没有正确释放内存
2. **实体累积**：掉落物、生物越来越多
3. **区块问题**：玩家探索新区域，加载大量区块

**解决方法**：
- 使用Spark分析是哪个插件导致
- 安装ClearLag定期清理
- 设置定时重启（不推荐，但有效）

### Q2：TPS正常但玩家还是说卡？
**A**：这不是服务器卡顿，可能是：
1. **客户端FPS低**：玩家电脑性能不足
2. **网络延迟**：玩家网络问题
3. **区块加载延迟**：硬盘读取慢（换SSD）

**诊断方法**：
- 让玩家按F3查看FPS和Ping
- FPS低 → 客户端问题
- Ping高 → 网络问题
- 区块加载慢 → 硬盘问题

### Q3：服务器内存够用，但还是卡？
**A**：Minecraft主要吃CPU单核性能，内存只是其中一个因素：
1. **检查CPU使用率**：是否某个核心100%？
2. **查看MSPT**：超过50ms说明CPU处理不过来
3. **考虑升级CPU**：选择主频更高的型号

### Q4：加了很多内存为什么反而更卡？
**A**：Java的垃圾回收（GC）机制：
- 内存越大，GC扫描时间越长
- GC时游戏会暂停（Stop the World）
- 解决：使用优化的JVM参数（Aikar's Flags）

**最佳方案**：
- 4-8GB足够大部分服务器
- 超过16GB需要特殊调优
- 与其加内存，不如优化配置

### Q5：哪些插件最容易导致卡顿？
**A**：高风险插件类型：
1. **反作弊插件**（如旧版AAC）：每tick检查所有玩家
2. **动态地图**（如Dynmap）：实时渲染地图
3. **经济/商店插件**（配置不当）：频繁数据库操作
4. **自定义生物/物品插件**（如ItemsAdder）：增加大量实体计算

**建议**：
- 选择口碑好、持续更新的插件
- 新装插件先在测试服试用
- 定期使用Spark检查插件性能

### Q6：如何判断是插件问题还是配置问题？
**A**：科学方法：
1. **备份服务器**
2. **移除一半插件**，测试
3. 如果正常，问题在移除的那一半；如果还卡，问题在另一半
4. **二分法**继续缩小范围
5. 最终定位到具体插件

### Q7：模组服如何优化？
**A**：模组服优化更困难：
1. **选择轻量级模组**：避免大型科技/魔法模组
2. **限制机械数量**：玩家规定不能建造过多机器
3. **分区块管理**：FTB Chunks等模组声明区块保持加载
4. **使用优化模组**：
   - FoamFix
   - VanillaFix
   - TexFix
5. **定期清理**：定期清理无主机器和管道

### Q8：什么时候该考虑换更好的服务器？
**A**：出现以下情况时：
1. 已经做了所有优化，TPS仍然低于15
2. CPU单核使用率长期100%
3. 玩家增长，现有硬件不够用
4. 计划开大型模组服

**升级优先级**：
1. **CPU单核性能**（最重要！）
2. **SSD硬盘**
3. **内存容量**
4. **网络带宽**

## 总结

记住：**预防胜于治疗**。提前优化配置、限制实体、清理垃圾，比等到卡顿再救火要好得多。

依旧客套一句，祝你的服务器运行流畅，玩家开心!🎮

## 附录A：快速检查checklist

当服务器卡顿而你又不知道该怎么办时，就按照这份checklist逐项检查：

::: steps
1. 确认卡顿类型

    - [ ] 查看TPS（目标：20）
    - [ ] 询问是所有玩家还是个别玩家卡
    - [ ] 确认是服务器/客户端/网络问题

2. 检查基础指标

    - [ ] CPU使用率（警戒：单核>90%）
    - [ ] 内存使用（警戒：>85%）
    - [ ] 硬盘空间（警戒：>90%）
    - [ ] 网络带宽（警戒：接近上限）

3. 实体检查

    - [ ] 总实体数量（警戒：>1000）
    - [ ] 掉落物数量（警戒：>500）
    - [ ] 生物数量（警戒：>300）
    - [ ] 清理不必要的实体

4. 区块检查

    - [ ] 视距设置（建议：4-8）
    - [ ] 已加载区块数（根据在线人数评估）
    - [ ] 是否有玩家在高速飞行/传送

5. 插件检查

    - [ ] 运行Spark分析
    - [ ] 查看哪些插件占用最多
    - [ ] 检查是否有报错
    - [ ] 禁用可疑插件测试

6. 配置检查

    - [ ] server.properties是否优化
    - [ ] spigot.yml/paper.yml是否优化
    - [ ] 启动参数是否合理
    - [ ] JVM内存分配是否合适

7. 长期改进

    - [ ] 制定定期清理计划
    - [ ] 设置自动重启
    - [ ] 安装监控插件
    - [ ] 优化玩家建筑和机械

:::

## 附录B：懒人工具列表

> 为什么叫“懒人”？因为我知道你是个“懒人”，懒得找插件，我宠你你就乐着吧你。

### 性能分析工具
| 工具名 | 类型 | 用途 |
|-------|------|------|
| Spark | 插件/模组 | 全面性能分析 |
| Timings<Badge type="warning" text="弃用" /> | Paper内置 | 性能报告 |
| LagMonitor | 插件 | 实时监控 |
| VisualVM | 外部程序 | JVM深度分析 |

### 优化插件
| 插件名 | 功能 |
|-------|------|
| ClearLagg | 清理实体，防止卡顿 |
| FarmControl | 限制农场规模 |
| StackMob | 生物堆叠，减少实体 |
| MergedMobs | 合并相同生物 |
| EntityTrackerFixer | 修复实体追踪 |
| ChunkBuster | 清理卡顿区块 |

### 服务端选择

> 详情见：[服务器核心入门](/guide/ji-chu-zhi-shi-xue-xi/server-core/)

| 服务端 | 适用场景 | 性能 | 兼容性 |
|--------|---------|------|--------|
| Paper | 通用，强烈推荐 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Purpur | Paper+更多自定义 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| Airplane | 极限性能优化 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| Spigot | 老牌服务端 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Fabric | 模组服，轻量 | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| Forge | 模组服，兼容性好 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |